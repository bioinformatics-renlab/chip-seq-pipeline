Fri May 26 16:38:17 PDT 2017 # Analysis Began
Provided cores: 12
Rules claiming more threads will be scaled down.
Job counts:
	count	jobs
	1	bam2bw
	1	bam_finalize
	1	bam_markdup
	1	bwa_map
	1	phantom
	1	vanilla
	6

rule bwa_map:
    input: fastq/test.fastq.bz2
    output: bam/test.raw.sai, qc/test.raw.flagstat.qc, bam/test.raw.srt.bam, bam/test.filt.srt.bam, qc/test.filt.flagstat.qc
    log: logs/bwa_map/test.log
    jobid: 5
    wildcards: sample=test
    threads: 6

bwa aln -q 5 -l 32 -k 2 -t 6 /mnt/silencer2/share/bwa_indices/hg19.fa <( bzcat fastq/test.fastq.bz2 ) > bam/test.raw.sai 2> logs/bwa_map/test.log;bwa samse /mnt/silencer2/share/bwa_indices/hg19.fa bam/test.raw.sai <(bzcat fastq/test.fastq.bz2) 2> logs/bwa_map/test.log|samtools view -@ 6 -Su - |samtools sort -@ 6 - -o bam/test.raw.srt.bam;samtools flagstat bam/test.raw.srt.bam > qc/test.raw.flagstat.qc;samtools view -@ 6 -F 1804 -q 30 -b bam/test.raw.srt.bam > bam/test.filt.srt.bam;samtools flagstat bam/test.filt.srt.bam > qc/test.filt.flagstat.qc
Removing temporary output file bam/test.raw.sai.
Removing temporary output file bam/test.raw.srt.bam.
Finished job 5.
1 of 6 steps (17%) done

rule bam_markdup:
    input: bam/test.filt.srt.bam, qc/test.filt.flagstat.qc
    output: bam/test.dupmark.bam, qc/test.dup.flagstat.qc
    log: logs/markdup/test.markdup.log
    jobid: 4
    wildcards: sample=test

java -Xmx4G -jar /mnt/silencer2/share/picard-tools-2.1.0/picard.jar MarkDuplicates TMP_DIR=tmp INPUT=bam/test.filt.srt.bam OUTPUT=bam/test.dupmark.bam METRICS_FILE=qc/test.dup.flagstat.qc VALIDATION_STRINGENCY=LENIENT ASSUME_SORTED=true REMOVE_DUPLICATES=false 2> logs/markdup/test.markdup.log
Removing temporary output file bam/test.filt.srt.bam.
Finished job 4.
2 of 6 steps (33%) done

rule bam_finalize:
    input: bam/test.dupmark.bam, qc/test.dup.flagstat.qc
    output: bam/test.filt.nodup.srt.bam, qc/test.filt.nodup.srt.flagstat.qc, qc/test.filt.nodup.srt.pbc.qc
    jobid: 3
    wildcards: sample=test

samtools view -F 1804 -b bam/test.dupmark.bam > bam/test.filt.nodup.srt.bam;samtools index bam/test.filt.nodup.srt.bam;samtools flagstat bam/test.filt.nodup.srt.bam > qc/test.filt.nodup.srt.flagstat.qc;bedtools bamtobed -i bam/test.dupmark.bam |awk 'BEGIN{OFS="\t"}{print $1,$2,$3,$6}' |grep -v 'chrM' | sort -T . | uniq -c |awk 'BEGIN{mt=0;m0=0;m1=0;m2=0} ($1==1){m1=m1+1} ($1==2){m2=m2+1}{m0=m0+1}{mt=mt+$1} END{printf"%d\t%d\t%d\t%d\t%f\t%f\t%f\n",mt,m0,m1,m2,m0/mt,m1/m0,m1/m2}' > qc/test.filt.nodup.srt.pbc.qc
Write-protecting output file bam/test.filt.nodup.srt.bam.
Removing temporary output file bam/test.dupmark.bam.
Finished job 3.
3 of 6 steps (50%) done

rule bam2bw:
    input: bam/test.filt.nodup.srt.bam
    output: bigWig/test.filt.nodup.srt.gs, bigWig/test.filt.nodup.srt.bw
    jobid: 1
    wildcards: sample=test

ext_len=$(awk '{print $10;exit}' <(samtools view bam/test.filt.nodup.srt.bam)|awk '{print 300-length}');samtools view -H bam/test.filt.nodup.srt.bam | awk '$1 == "@SQ" {OFS="\t";print $2,$3}' - | sed 's/.N://g' > bigWig/test.filt.nodup.srt.gs;samtools view -b bam/test.filt.nodup.srt.bam | bedtools bamtobed |bedtools slop -s -l 0 -r $ext_len -i stdin -g bigWig/test.filt.nodup.srt.gs |bedtools genomecov -g bigWig/test.filt.nodup.srt.gs -i stdin -bg |/mnt/silencer2/share/ENCODE/bin/wigToBigWig stdin bigWig/test.filt.nodup.srt.gs bigWig/test.filt.nodup.srt.bw
rule phantom:
    input: bam/test.filt.nodup.srt.bam
    output: qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.qc, qc/test.cc.temp, test.filt.nodup.sample.15.0.SE.tagAlign.gz, qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.plot.pdf, test.filt.nodup.srt.SE.tagAlign.gz
    log: logs/phantompeak/test.phantom.log
    jobid: 2
    wildcards: sample=test

bedtools bamtobed -i bam/test.filt.nodup.srt.bam | awk 'BEGIN{OFS="\t"}{$4="N";$5="1000";print $0}' | gzip -c > test.filt.nodup.srt.SE.tagAlign.gz;zcat test.filt.nodup.srt.SE.tagAlign.gz | grep -v "chrM" | shuf -n 15000000 |gzip -c > test.filt.nodup.sample.15.0.SE.tagAlign.gz;Rscript /mnt/silencer2/share/phantompeakqualtools/run_spp_nodups.R -c=test.filt.nodup.sample.15.0.SE.tagAlign.gz -filtchr=chrM -savp=qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.plot.pdf -out=qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.qc -tmpdir=tmp -rf &> logs/phantompeak/test.phantom.log;sed -r 's/,[^\t]+//g' qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.qc > qc/test.cc.temp;cp qc/test.cc.temp qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.qc
Removing temporary output file qc/test.cc.temp.
Removing temporary output file test.filt.nodup.sample.15.0.SE.tagAlign.gz.
Removing temporary output file test.filt.nodup.srt.SE.tagAlign.gz.
Finished job 2.
4 of 6 steps (67%) done
Removing temporary output file bigWig/test.filt.nodup.srt.gs.
Finished job 1.
5 of 6 steps (83%) done

localrule vanilla:
    input: bigWig/test.filt.nodup.srt.bw, bam/test.filt.nodup.srt.bam, qc/test.filt.nodup.sample.15.0.SE.tagAlign.gz.cc.qc
    jobid: 0

Finished job 0.
6 of 6 steps (100%) done
Fri May 26 16:46:22 PDT 2017 # Analysis finished
